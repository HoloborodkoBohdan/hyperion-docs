---
title: Contract Service
description: Internal component view of the Contract Service
---

<Diagram
  lang="mermaid"
  chart="
graph TD;

    %% External Callers
    APIController[<a href='../c3'>API Controllers</a>]
    WebController[<a href='../c3'>Web Controllers</a>]

    subgraph ContractService[Contract Service]

        %% Core Components
        subgraph CoreComponents[Core Components]
            ContractValidator[Contract Validator<br/>Validates contract data and business rules]
            ContractManager[Contract Manager<br/>CRUD operations for contracts]
            ContractNumberGenerator[Contract Number Generator<br/>Generates unique YYYYMMNNN numbers]
            OverlapValidator[Overlap Validator<br/>Prevents overlapping active contracts]
        end

        %% Business Logic
        subgraph BusinessLogic[Business Logic]
            ContractCreationHandler[Contract Creation Handler<br/>Orchestrates contract creation workflow]
            ContractActivation[Contract Activation<br/>Activates contracts with PDFs]
            PeriodValidator[Period Validator<br/>Validates start/end dates]
            TemplateManager[Template Manager<br/>Manages contract templates]
        end

        %% Data Access
        subgraph DataAccess[Data Access Layer]
            ContractRepo[Contract Repository<br/>fop_contract CRUD]
            TemplateRepo[Template Repository<br/>fop_contract_template access]
            CompanyRepo[Company Repository<br/>fop_company access]
        end
    end

    %% External Services
    EmployeeService[<a href='employee-service'>Employee Service</a>]
    ReportService[Report Service]

    %% External Systems
    PostgresDB[(üóÑÔ∏è PostgreSQL Database)]

    %% Models
    subgraph Models[Data Models]
        FOPContract[fop_contract<br/>Contract records]
        FOPTemplate[fop_contract_template<br/>Contract templates]
        FOPCompany[fop_company<br/>Company data]
    end

    %% External to Core Components
    APIController --> ContractValidator
    APIController --> ContractManager
    WebController --> ContractManager
    WebController --> TemplateManager

    %% Core to Business Logic
    ContractValidator --> OverlapValidator
    ContractValidator --> PeriodValidator
    ContractManager --> ContractCreationHandler
    ContractManager --> ContractActivation
    ContractCreationHandler --> ContractNumberGenerator
    TemplateManager --> TemplateRepo

    %% Business Logic to External Services
    ContractCreationHandler --> EmployeeService
    ContractActivation --> ReportService

    %% Business Logic to Data Access
    ContractCreationHandler --> ContractRepo
    ContractCreationHandler --> CompanyRepo
    ContractActivation --> ContractRepo
    OverlapValidator --> ContractRepo
    PeriodValidator --> ContractRepo

    %% Data Access to Models
    ContractRepo --> FOPContract
    TemplateRepo --> FOPTemplate
    CompanyRepo --> FOPCompany

    %% Models to Database
    FOPContract --> PostgresDB
    FOPTemplate --> PostgresDB
    FOPCompany --> PostgresDB

    %% Styling
    classDef externalStyle fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#000
    classDef serviceStyle fill:#fff9c4,stroke:#f57f17,stroke-width:3px,color:#000
    classDef coreStyle fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#000
    classDef logicStyle fill:#c8e6c9,stroke:#388e3c,stroke-width:2px,color:#000
    classDef dataStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef modelStyle fill:#ede7f6,stroke:#5e35b1,stroke-width:2px,color:#000
    classDef dbStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px,color:#000
    classDef layerStyle fill:#f5f5f5,stroke:#9e9e9e,stroke-width:2px,color:#000

    class APIController,WebController externalStyle
    class EmployeeService,ReportService externalStyle
    class ContractService serviceStyle
    class CoreComponents,BusinessLogic,DataAccess,Models layerStyle
    class ContractValidator,ContractManager,ContractNumberGenerator,OverlapValidator coreStyle
    class ContractCreationHandler,ContractActivation,PeriodValidator,TemplateManager logicStyle
    class ContractRepo,TemplateRepo,CompanyRepo dataStyle
    class FOPContract,FOPTemplate,FOPCompany modelStyle
    class PostgresDB dbStyle
"
/>

## Overview

The **Contract Service** is a core component in the [FOP Backend](fop-backend) [Service Layer](../c3) responsible for managing FOP contract lifecycle, validation, and ensuring compliance with business rules such as contract number generation and overlap prevention.

See the [C3 Component Diagram](../c3) for how this service fits within the overall architecture.

## Responsibilities

### Core Functions
1. **Contract Validation** - Validates contract data, business rules, and compliance requirements
2. **Contract Management** - Create, read, update, and delete contract records
3. **Contract Number Generation** - Generates unique sequential numbers in YYYYMMNNN format
4. **Overlap Prevention** - Ensures no overlapping active contracts per employee

### Business Logic
1. **Contract Creation Handler** - Orchestrates the complete contract creation workflow with PDF generation
2. **Contract Activation** - Activates draft contracts once PDFs are generated
3. **Period Validator** - Validates start/end dates and future-dated contracts
4. **Template Manager** - Manages contract templates for different contract types

## Components

### Core Components Layer

| Component | Purpose |
|-----------|---------|
| **Contract Validator** | Validates contract data, checks business rules, ensures employee/company/template exist |
| **Contract Manager** | Handles CRUD operations, orchestrates contract lifecycle management |
| **Contract Number Generator** | Generates sequential contract numbers per company (format: YYYYMMNNN) |
| **Overlap Validator** | Checks for existing active contracts with overlapping date ranges |

### Business Logic Layer

| Component | Purpose |
|-----------|---------|
| **Contract Creation Handler** | Orchestrates full contract creation: validation ‚Üí numbering ‚Üí record creation ‚Üí PDF generation |
| **Contract Activation** | Transitions contract from 'draft' to 'running' state after PDF attachment |
| **Period Validator** | Validates start/end dates, supports future-dated and open-ended contracts |
| **Template Manager** | Manages contract templates, handles template selection and validation |

### Data Access Layer

| Component | Purpose |
|-----------|---------|
| **Contract Repository** | CRUD operations for `fop_contract` table |
| **Template Repository** | Read access to `fop_contract_template` table |
| **Company Repository** | Read access to `fop_company` table |

## Data Models

See the [ERD diagram](../../erd/fop-backend) for complete database schema.

| Model | Tables | Purpose |
|-------|--------|---------|
| **fop_contract** | `fop_contract` | Contract records with number, dates, state, and PDF attachments |
| **fop_contract_template** | `fop_contract_template` | Contract templates for different contract types |
| **fop_company** | `fop_company` | Company data including facsimile for PDF generation |

## Integration Points

### Internal Services
- **[Employee Service](employee-service)** - Validates employee exists and retrieves employee details before contract creation
- **Report Service** - Generates two PDF versions (with/without facsimile) for contracts
- **[API/Web Controllers](../c3)** - Access contract management functionality

### External Systems
- **[PostgreSQL Database](../../erd/fop-backend)** - Persistent storage for all contract data

## Usage in Workflows

### Contract Creation
Primary workflow shown in [Contract Creation sequence](../../sequence/contract-creation):

1. [FOP Manager](../../glossary/actors#fop-manager) initiates contract creation
2. Contract Service validates employee, company, and template
3. Checks for overlapping active contracts
4. Generates unique contract number (YYYYMMNNN format)
5. Creates draft contract record
6. Triggers Report Service for PDF generation
7. Receives two PDF attachments (with/without facsimile)
8. Links PDFs to contract and activates (state: 'running')
9. Returns HTTP 201 Created with contract details

## Contract Number Format

**Format:** `YYYYMMNNN`

**Example:** `202401045` = 45th contract in January 2024

**Rules:**
- Sequential per company
- Year (4 digits) + Month (2 digits) + Sequence (3 digits)
- Sequence resets monthly per company
- Unique identifier for audit and reference

## Key Business Rules

1. **Overlap Prevention** - Only one 'running' contract per employee at any given time
2. **Unique Numbering** - Contract numbers must be unique per company
3. **Draft Before Active** - Contracts start in 'draft' state, activate only after PDF generation
4. **Required Fields** - employee_id, company_id, template_id, start_date are mandatory
5. **Period Validation** - start_date must be less than or equal to end_date (if end_date provided)
6. **Template Validation** - Contract template must exist and be active
7. **PDF Requirement** - Two PDFs (with/without facsimile) must be attached before activation

## Contract States

| State | Description | Transitions |
|-------|-------------|-------------|
| **draft** | Contract created, awaiting PDF generation | ‚Üí running (after PDF attachment) |
| **running** | Active contract with PDFs attached | ‚Üí archived (manual) |
| **archived** | Historical contract, no longer active | (terminal state) |

## Error Handling

| Error Type | HTTP Status | Handling |
|------------|-------------|----------|
| **Employee Not Found** | 404 | Validate employee exists via Employee Service |
| **Company Not Found** | 404 | Check company_id exists in fop_company |
| **Template Not Found** | 404 | Check template_id exists and is active |
| **Overlapping Contract** | 409 | Return conflict with existing contract details |
| **Invalid Period** | 400 | Validate start_date less than or equal to end_date |
| **Number Generation Failed** | 500 | Log error, retry with transaction lock |
| **PDF Generation Failed** | 500 | Keep contract in 'draft' state, notify user |

## Performance Considerations

### Contract Number Generation
- Uses database sequence or atomic increment
- Transaction-level locking to prevent duplicates
- Indexed on (company_id, number) for fast lookups

### Overlap Validation
- Indexed query on (employee_id, state, start_date, end_date)
- Optimized for common case (no overlaps)
- Uses date range overlap logic to check if periods intersect

### Caching
- Contract templates cached in memory (rarely change)
- Company data cached per request
- Contract records not cached (frequently updated)
